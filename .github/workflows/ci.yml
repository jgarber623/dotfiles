name: CI

on:
  push:
  schedule:
    - cron: "2 16 * * 2"

jobs:
  test:
    name: Test
    runs-on: macos-13
    steps:
      - name: Remove pre-installed software
        run: |
          brew uninstall --force --ignore-dependencies $(brew list --formulae)
          brew uninstall --force --zap $(brew list --casks)
          brew untap --force $(brew tap)
          brew cleanup --prune-prefix
      - name: Uninstall Homebrew
        run: NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/uninstall.sh)"
      - name: Install Homebrew to /opt/homebrew
        run: |
          sudo mkdir -p /opt/homebrew
          sudo chown -R $(whoami) /opt/homebrew
          git clone --depth=1 https://github.com/Homebrew/brew /opt/homebrew
          ls -la /opt/homebrew
          ls -la /opt/homebrew/bin
          eval $("/opt/homebrew/bin/brew shellenv")
          brew update --force --quiet
          chmod -R go-w "$(brew --prefix)/share/zsh"
      - uses: actions/checkout@v4
      - name: Install dotfiles dependencies
        run: brew install antidote starship rbenv stow
      - name: Remove existing config file(s)
        run: rm -f ~/.gitconfig
      - name: Install dotfiles
        run: make install
      - name: Test dotfiles installation
        run: |
          [[ ! -L "${HOME}/.zprofile" ]] && exit 1
          source $HOME/.zprofile
          source $HOME/.zshrc
          [[ $(git config --global --get user.name) != "Jason Garber ]] && exit 1
        shell: zsh {0}

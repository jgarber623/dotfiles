name: CI

on:
  push:
  schedule:
    - cron: "2 16 * * 2"

jobs:
  test:
    name: Test
    runs-on: macos-13
    steps:
      - name: Remove pre-installed software
        run: |
          brew uninstall --force --ignore-dependencies $(brew list --formulae)
          brew uninstall --force --zap $(brew list --casks)
          brew untap --force $(brew tap)
          brew cleanup --prune-prefix
      - uses: actions/checkout@v4
      - name: Install dotfiles dependencies
        run: brew install antidote starship rbenv stow
      - name: Remove existing config file(s)
        run: rm -f ~/.gitconfig
      - name: Install dotfiles
        run: make install
      - name: Test dotfiles installation
        run: |
          echo "üß™ Testing symlink installation..."
          [[ ! -L "${HOME}/.zprofile" ]] && exit 1
          echo "üç∫ Accounting for Homebrew running on an Intel system..."
          [[ $(uname -m) == "x86_64" ]] && sed -i -e 's/\/opt\/homebrew/\/usr\/local/' zsh/.zprofile
          echo "üßô‚Äç‚ôÇÔ∏è Sourcing ZSH files..."
          source $HOME/.zprofile
          source $HOME/.zshrc
          echo "üë®üèª‚Äçüíª Validating Git configuration..."
          [[ "$(git config --global --get user.name)" != "Jason Garber" ]] && exit 1
        shell: zsh {0}

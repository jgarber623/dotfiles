- name: Install packages with Homebrew
  homebrew:
    name: "{{ item }}"
    state: latest
  with_items: "{{ ruby_homebrew_packages }}"

- name: Create {{ ruby_rubies_directory }}
  file:
    path: "{{ ruby_rubies_directory }}"
    owner: "{{ ansible_user }}"
    group: staff
    state: directory
  become: yes

- name: Create directories
  file:
    path: ~/{{ item }}
    state: directory
  with_items: "{{ ruby_directories }}"

- name: Link {{ ruby_rubies_directory }}
  file:
    src: "{{ ruby_rubies_directory }}"
    dest: ~/.rbenv/versions
    state: link
    force: yes

- name: Link configuration files
  file:
    src: "{{ role_path }}/files/{{ item }}"
    dest: ~/{{ item }}
    state: link
    force: yes
  with_items: "{{ ruby_linked_files }}"

- name: Install Ruby versions
  command: ruby-build {{ item }} {{ ruby_rubies_directory }}/{{ item }}
  args:
    creates: "{{ ruby_rubies_directory }}/{{ item }}"
  with_items: "{{ ruby_versions }}"

- name: Set global Ruby version
  command: rbenv global {{ ruby_global_version }}
  changed_when: false
